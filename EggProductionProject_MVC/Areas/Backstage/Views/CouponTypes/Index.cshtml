@model EggProductionProject_MVC.Models.CouponType
@{
    var antiForgeryToken = Html.AntiForgeryToken().ToString();
}

@section Styles {
@*     <link href="~/lib/datatables/css/jquery.datatables.min.css" rel="stylesheet" />
    <!-- FixedHeader CSS -->
    <link rel="stylesheet" href="//cdn.datatables.net/fixedheader/3.3.1/css/fixedHeader.dataTables.min.css">
    <!-- FixedHeader 样式 -->
    <link rel="stylesheet" href="https://cdn.datatables.net/fixedcolumns/5.0.1/css/fixedColumns.dataTables.css"> *@

    <link rel="stylesheet" href="https://cdn.datatables.net/2.1.3/css/dataTables.dataTables.css">
    <!-- FixedHeader 样式 -->
    <link rel="stylesheet" href="https://cdn.datatables.net/fixedcolumns/5.0.1/css/fixedColumns.dataTables.css">
    <style>

        .table-control-n {
            overflow-x: scroll;
            width: 100%;
            clear: left;
        }

        .dataTables_scrollBody::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        .dataTables_scrollBody::-webkit-scrollbar-track {
            border-radius: 3px;
            background: rgba(0,0,0,0.06);
            -webkit-box-shadow: inset 0 0 5px rgba(0,0,0,0.08);
        }

        .dataTables_scrollBody::-webkit-scrollbar-thumb {
            border-radius: 3px;
            background: rgba(0,0,0,0.12);
            -webkit-box-shadow: inset 0 0 10px rgba(0,0,0,0.2);
        }

        .dataTables_wrapper.no-footer .dataTables_scrollBody {
            border-bottom: none;
        }

        .table-striped > tbody > tr:nth-of-type(odd) {
            --bs-table-accent-bg: #fff;
            color: var(--bs-table-striped-color);
        }

        .table-primary {
            --bs-table-bg: #446188;
            --bs-table-striped-bg: #c5d7f2;
            --bs-table-striped-color: #000;
            --bs-table-active-bg: #bacbe6;
            --bs-table-active-color: #000;
            --bs-table-hover-bg: #bfd1ec;
            --bs-table-hover-color: #000;
            color: #fff;
            border-color: #bacbe6;
        }

        .table-hover > tbody > tr:hover {
            --bs-table-accent-bg: var(--bs-table-hover-bg);
            color: var(--bs-table-hover-color);
        }

        .dataTables_wrapper .dataTables_scroll div.dataTables_scrollBody > table > tbody > tr > td {
            vertical-align: middle;
            text-align: center;
        }

        .dataTables_wrapper .dataTables_filter{
            padding-bottom:20px;
        }

        table.dataTable thead .sorting{
            text-align:center;
        }

        .x_title h4 {
            font-size:22px;
            font-weight:600;
        }

        .big-title{
            font-size:18px;
            margin:20px 40px 0px 40px;
            width:auto;
        }

        .table > :not(:last-child) > :last-child > * {
            background: var(--bs-table-bg);
            white-space: nowrap;
        }

    </style>
}





<button type="button " data-id="0" class="btn btn-primary edit-button" >
    Launch
</button>

    <div class="row" style="">
    <h3 class="big-title">優惠券列表</h3>
    <div class="col-md-12 col-sm-12 ">
        <div class="dashboard_graph m-4 p-4">
            <div class="row x_title mb-4">
                <div class="col-md-6">
                    <h4>查詢</h4>
                </div>

            </div>

           

        </div>

    </div>
    <div class="col-md-12 col-sm-12  mt-3">
        <div class="dashboard_graph m-4 p-4">
            <div class="row x_title mb-4">
                <div class="col-md-6">
                    <h4>優惠券列表</h4>
                </div>
                
            </div>
            
                <table class="table table-striped table-hover">
                    <thead class="table-primary ">
                    </thead>
                    <tbody class="123">
                    </tbody>
                </table>
            
        </div>
        
</div>
</div>



<!-- Modal -->
<div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Modal title</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="editFormContainer"></div>

               
            </div>

        </div>
    </div>
</div>






@section Scripts {
    
    @* <script src="~/lib/datatables/js/jquery.datatables.min.js"></script> *@
    @* <script src="//cdn.datatables.net/fixedheader/3.3.1/js/dataTables.fixedHeader.min.js"></script> *@

    <!-- DataTables 核心 JS -->
    <script src="https://cdn.datatables.net/2.1.3/js/dataTables.js"></script>
    <!-- FixedHeader JS -->
    <script src="https://cdn.datatables.net/fixedcolumns/5.0.1/js/dataTables.fixedColumns.js"></script>
    <!-- FixedColumns JS -->
    <script src="https://cdn.datatables.net/fixedcolumns/5.0.1/js/fixedColumns.dataTables.js"></script>

    <script>

       

        $(document).ready(function () {
           $("table").dataTable({
                scrollX: "auto",
                // autoWidth: false,
                ajax: {
                    type: "GET",
                    url: "/Backstage/CouponTypes/IndexJson",
                    dataSrc: function (json) {
                        return json;
                    },
                },
                
                columnDefs: [
                    {
                        targets: -1, 
                        render: function (data, type, row) {
                            return `
                                            <button type="button " data-id="${row.couponTypeNo}" class="btn  edit-button " >
                                              <i class="fa-solid fa-pen" style="color: #8ba3d2;"></i>
                            </button>
                              `;
                        }
                    }
                ],
                lengthMenu: [[4, 12, 20, -1], [4, 12, 20, "All"]],
                // fixedColumns: {
                //     leftColumns: 1 //左邊要固定的欄位數，如果右側需要固定可以用rightColunms
                // },
                fixedColumns: {
                    start: 0,
                    end: 1
                },
                columns: [
                    { "data": "couponTypeNo", "width": "auto", "title": "優惠券號碼", "visible": false },
                    { "data": "name", "width": "auto", "title": "優惠券名稱" },
                    { "data": "price", "width": "auto", "title": "優惠價格" },
                    { "data": "minimum", "width": "auto", "title": "最低消費" },
                    { "data": "publicStatusNo", "width": "auto", "title": "公開狀態號碼", "visible": false },
                    { "data": "statusDescription", "width": "auto", "title": "公開狀態" },
                    { "data": "startTime", "width": "auto", "title": "開始時間" },
                    { "data": "endTime", "width": "auto", "title": "結束時間" },
                    { "data": "useAlone", "width": "auto", "title": "獨立使用" },
                    { "data": "empName", "width": "auto", "title": "操作員工" },
                    { "data": "", "width": "auto", "title": "" },

                ],
                fixedHeader: { header: true },
                language: {
                    url: '//cdn.datatables.net/plug-ins/2.1.2/i18n/zh-HANT.json',
                },
            })

            $(document).on('click', '.edit-button', function () {
                var id = $(this).data('id'); // 从按钮的 data-id 属性获取 ID

                $.ajax({
                    url: '@Url.Action("Edit", "CouponTypes")/' + id, // 调用 Edit 方法获取表单
                    type: 'GET',
                    success: function (data) {
                        $('#editFormContainer').html(data); // 将返回的部分视图插入到指定的容器中

                        // 初始化和显示 modal
                        var modal = new bootstrap.Modal(document.getElementById('exampleModal'));
                        modal.show();
                        document.getElementById('saveChangesButton').addEventListener('click', function () {
                            // 这里可以添加保存数据的逻辑
                            // 成功后隐藏 modal
                            modal.hide();
                        });
                    },
                    error: function (xhr, status, error) {
                        console.error('AJAX请求失败: ', status, error);
                        // 可以在此显示一个错误消息
                    }
                });
            });


            $('#editFormContainer').on('submit', '#editForm', function (event) {
                event.preventDefault(); 

                var formData = $(this).serialize(); // 获取表单数据
                var antiForgeryToken = $('input[name="__RequestVerificationToken"]').val(); 

                $.ajax({
                    url: '@Url.Action("Edit", "CouponTypes")', 
                    type: 'POST',
                    headers: {
                        'RequestVerificationToken': antiForgeryToken 
                    },
                    data: formData,
                    dataType: 'json', 
                    success: function (response) {
                        if (response.success) {
                            $('#editFormContainer').html('');

                            var table = $("table").DataTable(); 
                            table.ajax.reload();
                         
                        } else {
                            alert(response.message); 
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error('Error:', status, error); 
                    }
                });
            });
        });

        // $(document).ready(function () {
        //     $('#example').DataTable({
        //         scrollX: true
        //     });
        // });


    </script>
}