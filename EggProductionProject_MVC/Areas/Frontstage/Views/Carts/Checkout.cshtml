@{
	Layout = "_FrontLayout_common";
}
@inject Microsoft.AspNetCore.Http.IHttpContextAccessor HttpContextAccessor
@using EggProductionProject_MVC.Data
@using Microsoft.AspNetCore.Identity

@section Styles {
	<style>

		.cart-card .cart-card-owner .img-outer {
			width: 30px;
			margin: 0px 16px;
			height: 30px;
			border-radius: 50%;
			overflow: hidden;
		}

			.cart-card .cart-card-owner .img-outer img {
				width: 100%;
				height: 100%;
				vertical-align: baseline;
			}

	</style>
}

<div class="title-bg mb-3">
	<img class="w-100"
		 src="~/FrontstageTemplate/assets/brand/layout/banners/banner_01.png"
		 alt="" />
</div>

<section class="py-3 py-lg-5 text-center container">
	<div class="step-nav">
		<div class="step step-one finished">
			<div class="radial-progress active" data-index="0">
				<div class="step-text">
					<p>step1</p>
					<p>購物車</p>
				</div>
			</div>
			<p class="step-num">1</p>
		</div>
		<div class="step finished">
			<div class="line">
				<div class="progress"></div>
			</div>
			<div class="radial-progress" data-index="1">
				<div class="step-text">
					<p>step2</p>
					<p>資料填寫</p>
				</div>
			</div>
			<p class="step-num">2</p>
		</div>
		<div class="step finished">
			<div class="line">
				<div class="progress"></div>
			</div>
			<div class="radial-progress" data-index="2">
				<div class="step-text">
					<p>step3</p>
					<p>確認完成</p>
				</div>
			</div>
			<p class="step-num">3</p>
		</div>
	</div>
</section>

<div class="album py-5 container-outer-n">
	<div class="container">


		<div class="row g-lg-5 payend-outer">


			<div class="payend-title">
				<h3>訂單明細</h3>
				<p>【共兩筆】</p>
			</div>

			<div class="col-lg-12 mt-3">

				<div class="row" id="div2">

					@* 		<div class="col col-sm-12 my-3">
					<div class="card-content-dec d-flex w-100 px-2 px-lg-4 ">
					<div class="w-100 "><p class="mb-2  ms-2">訂單編號<span class="ms-3">O202406080001</span> </p></div>
					</div>
					<div class="card shadow-sm cart-card">
					<div class="cart-card-owner">
					<div class="ck-farm d-flex align-items-center">
					<div class="img-outer">
					<img src="~/FrontstageTemplate/assets/brand/layout/mug.png" alt="" />
					</div>
					<p class="ck-farm-name p-0 m-0">葛瑞絲牧場</p>
					</div>
					</div>
					<hr />
					<div class="cart-card-item w-100">
					<div class="card-body-img d-flex w-100 px-3">
					<div class="d-flex flex-column">

					<div class="img_box">
					<img src="~/FrontstageTemplate/assets/brand/page/cart/profuct_1.png" />
					</div>
					</div>


					<div class="card-body flex-row align-items-center">
					<div class="w-100 d-flex flex-column flex-lg-row justify-content-between align-items-start">
					<div class="w-50 d-flex flex-column justify-content-between align-items-start">
					<h5>日成放牧蛋</h5>
					<small class="describe">雞蛋</small>
					</div>
					<div class="w-100 bottom_item flex-md-row align-items-md-center me-3">
					<div class="w-100 d-flex flex-column flex-column justify-content-between align-items-start align-items-lg-end ">
					<big class="price">NT$ 1,200</big>
					</div>
					<div class=" w-100 d-flex flex-column justify-content-center align-items-end ">
					<big class="price">X 1</big>
					</div>
					<div class="w-100  flex-column justify-content-center align-items-end align-items-lg-end d-none d-lg-flex">
					<big class="card-total price">NT$ 1,200</big>
					</div>
					</div>

					</div>


					</div>
					</div>
					</div>
					</div>
					</div>
					<div class="col col-sm-12 my-3">
					<div class="card-content-dec d-flex w-100 px-2 px-lg-4 ">
					<div class="w-100 "><p class="mb-2  ms-2 ms-md-2">訂單編號<span class="ms-3">O202406080001</span> </p></div>
					</div>
					<div class="card shadow-sm cart-card">
					<div class="cart-card-owner">
					<div class="ck-farm d-flex align-items-center">
					<div class="img-outer">
					<img src="~/FrontstageTemplate/assets/brand/layout/mug.png" alt="" />
					</div>
					<p class="ck-farm-name p-0 m-0">葛瑞絲牧場</p>
					</div>
					</div>
					<hr />
					<div class="cart-card-item w-100">
					<div class="card-body-img d-flex w-100 px-3">
					<div class="d-flex flex-column">
					<!-- <p class="card-content-dec">訂單商品</p> -->
					<div class="img_box">
					<img src="~/FrontstageTemplate/assets/brand/page/cart/profuct_1.png" />
					</div>
					</div>


					<div class="card-body flex-row align-items-center">
					<div class="w-100 d-flex flex-column flex-lg-row justify-content-between align-items-start">
					<div class="w-50 d-flex flex-column justify-content-between align-items-start">
					<h5>日成放牧蛋</h5>
					<small class="describe">雞蛋</small>
					</div>
					<div class="w-100 bottom_item flex-md-row align-items-md-center me-3">
					<div class="w-100 d-flex flex-column flex-column justify-content-between align-items-start align-items-lg-end ">
					<big class="price">NT$ 1,200</big>
					</div>
					<div class=" w-100 d-flex flex-column justify-content-center align-items-end ">
					<big class="price">X 1</big>
					</div>
					<div class="w-100  flex-column justify-content-center align-items-end align-items-lg-end d-none d-lg-flex">
					<big class="card-total price">NT$ 1,200</big>
					</div>
					</div>

					</div>


					</div>
					</div>
					</div>
					</div>
					</div>

					*@
				</div>

			</div>






		</div>
		<div class="row my-4 mx-lg-5 ">
			<div class="col-lg-12 mt-4">
				<div class="card cal-box no-border-n p-0">
					<div class="card-body py-0 px-0 px-lg-5">
						<div>
							<div class="o_price_total cal-box-list">
								<p class="my-0">訂單成立時間</p>
								<span id="orderCreatedTime">2024-06-08 11:34:54</span>
							</div>
							<hr>
							<div class="o_price_total cal-box-list mb-3">
								<p class="my-0">付款方式</p>
								<span id="payment">信用卡</span>
							</div>
							<div class="o_price_total cal-box-list mb-3">
								<p class="my-0">付款狀態</p>
								<span id="isPay"> 已付款</span>
							</div>
							<hr>
							<div class="discount_total cal-box-list mb-3">
								<div class="d-flex justify-content-start align-items-center">
									<p class="my-0 me-3">組合優惠</p>
								</div>
								<span id="comboDiscount">無</span>
							</div>
							<div class="discount_total cal-box-list mb-3">
								<div class="d-flex justify-content-start align-items-center">
									<p class="my-0 me-3">商城代幣折抵</p>
								</div>
								<span id="coinDiscount">- $ 0</span>
							</div>
							<div class="discount_total cal-box-list mb-3">
								<div class="d-flex justify-content-start align-items-center">
									<p class="my-0 me-3">優惠券折扣</p>
								</div>
								<span id="couponDiscount">- $ 0</span>
							</div>
							<hr>
							<div class="price_total cal-box-list mb-3">
								<h4 class="my-0">實際結帳金額</h4>
								<span id="finalAmount">NT$2,400</span>
							</div>
							<div class="backCoin_total cal-box-list">
								<h5 class="my-0">本次訂單商城代幣回饋</h5>
								<span id="coinBack">$ 24</span>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="col-lg-12 d-flex justify-content-center mt-5">
				<button type="submit" class="btn buy-btn light-btn-n my-0 mx-3 my-lg-2">
					<h5 class="mb-0">繼續購物</h5>
				</button>
				<button type="submit" class="btn buy-btn dark-btn-n my-0 mx-3 my-lg-2">
					<h5 class="mb-0">查看更多明細</h5>
				</button>
			</div>
		</div>
	</div>
</div>


@section Scripts {



	<script>

		window.onload = function () {
			if (!sessionStorage.getItem('reloaded')) {
				sessionStorage.setItem('reloaded', 'true');
				setTimeout(function () {
					window.location.href = window.location.href;
				}, 1000); 
			} else {
				sessionStorage.removeItem('reloaded');
			}
		};

		const postData = JSON.parse(sessionStorage.getItem('postData'));
		if (!postData) {
			window.location.href = 'https://localhost:7080/Identity/Account/Login';
		}
		console.log("asd", postData);

		let NowMemberSid = postData.memberSid;
		let orderNumbers = postData.orderNumbers; // 数组
		let combo = postData.combo; // 1
		let usecoin = postData.usecoin; // 0
		let couponSid = postData.couponSid; // null
		let paymentNo = postData.paymentNo; // 2

		// 计算订单数量
		let count = orderNumbers.length;

		// 获取 <p> 元素
		const countElement = document.querySelector('.payend-title p');

		// 更新 <p> 元素的内容
		if (countElement) {
			// 使用预先计算的 orderCount 变量
			countElement.innerHTML = `【共${count}筆】`;
		}

		const paymentElement = document.getElementById('payment');
		const isPayElement = document.getElementById('isPay');


		if (paymentNo == 1) {
			paymentElement.textContent = "信用卡";
			isPayElement.textContent = "已付款";
		} else if (paymentNo == 2) {
			paymentElement.textContent = "貨到付款";
			isPayElement.textContent = "未付款";
		} else {

			paymentElement.textContent = "未知支付方式";
			isPayElement.textContent = "未知狀態";
		}



		const comboDiscountElement = document.getElementById('comboDiscount');
		if (combo == 1) {
			comboDiscountElement.textContent = "無";
		} else {
			comboDiscountElement.textContent = "9折";
		}
		document.getElementById('coinDiscount').textContent = `-$ ${usecoin}`;

		$(document).ready(function () {


			function updateSubmitData() {
				const discountText = document.querySelector('#part-2 .percent_discount span').textContent.trim();
				submitdata.combo = discountText === '無' ? 1 : 0.9;

				const coinText = document.querySelector('#part-2 .coin_use span').textContent.replace(/[^0-9]/g, '').trim();
				submitdata.usecoin = parseInt(coinText, 10) || 0;

			}

			const BuyOrder = orderNumbers;

			const loadBuyCarts = async () => {
				const api = '@Url.Content("~/Frontstage/CartsAPI/GetOrdersByNumbers")';
				const response = await fetch(api, {
					method: 'POST',
					body: JSON.stringify(BuyOrder),
					headers: {
						'Content-Type': 'application/json'
					}
				});
				const data = await response.json();
				console.log("data", data);


				const generateProductsHtml1 = (orderDetails) => {
					return orderDetails.map(orderDetail => `
								<div class="cart-card-item w-100">
									<div class="card-body-img d-flex w-100 px-3">
										<div class="d-flex flex-column">
											<div class="img_box">
																<img src="${orderDetail.productImagePath}" />
											</div>
										</div>
										<div class="card-body flex-row align-items-center">
											<div class="w-100 d-flex flex-column flex-lg-row justify-content-between align-items-start">
												<div class="w-50 d-flex flex-column justify-content-between align-items-start">
																	<h5>${orderDetail.pName}</h5>
																	<small class="describe">${orderDetail.psName}</small>
												</div>
												<div class="w-100 bottom_item flex-md-row align-items-md-center me-3">
													<div class="w-100 d-flex flex-column justify-content-between align-items-start align-items-lg-end">
														<big class="price">NT$ ${orderDetail.buyPrice}</big>
													</div>
													<div class="w-100 d-flex flex-column justify-content-center align-items-end">
														<big class="price">X ${orderDetail.qty}</big>
													</div>
													<div class="w-100 flex-column justify-content-center align-items-end align-items-lg-end d-none d-lg-flex">
														<big class="card-total price">NT$ ${orderDetail.buyPrice * orderDetail.qty}</big>
													</div>
												</div>
											</div>
										</div>
									</div>
								</div>
							`).join('<hr />');
				};

				const generateStoresHtml1 = (orders) => {
					return orders.map(order => `
								<div class="col col-sm-12 my-3">
									<div class="card-content-dec d-flex w-100 px-2 px-lg-4">
										<div class="w-100"><p class="mb-2 ms-2">訂單編號<span class="ms-3">${order.orderNo}</span></p></div>
									</div>
									<div class="card shadow-sm cart-card">
										<div class="cart-card-owner">
											<div class="ck-farm d-flex align-items-center">
												<div class="img-outer">
																			<img  src="${order.storeImagePath}"  />
												</div>
												<p class="ck-farm-name p-0 m-0">${order.company}</p>
											</div>
										</div>
										<hr />
										${generateProductsHtml1(order.orderDetails)}
									</div>
								</div>
							`).join('');
				};


				const divSpots1 = document.getElementById('div2');
				console.log("divSpots1", divSpots1)
				divSpots1.innerHTML = generateStoresHtml1(data.orders);


				function formatDate(dateString) {
					const date = new Date(dateString);


					const year = date.getFullYear();
					const month = String(date.getMonth() + 1).padStart(2, '0');
					const day = String(date.getDate()).padStart(2, '0');
					const hours = String(date.getHours()).padStart(2, '0');
					const minutes = String(date.getMinutes()).padStart(2, '0');
					const seconds = String(date.getSeconds()).padStart(2, '0');


					return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
				}

				const orderCreatedTime = formatDate(data.orders[0].orderCreatedTime);
				document.getElementById('orderCreatedTime').textContent = orderCreatedTime;

				document.getElementById('couponDiscount').textContent = `- $ ${data.couponPrice}`;
				document.getElementById('finalAmount').textContent = `NT$ ${data.allPrice}`;
				document.getElementById('coinBack').textContent = `$ ${data.totalStoreCoin}`;
			};


			loadBuyCarts();



		});
	</script>
}